<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.c503.sc.jxwl.vehiclemonitor.dao.IWayBillStatisticalDao">
  	<resultMap id="BaseResultMap" type="com.c503.sc.jxwl.vehiclemonitor.bean.WayBillStatisticalEntity">
		<id     column="ID"                     property="id"                   jdbcType="VARCHAR" />
		<result column="LICENCE_PLATE_NO"       property="licencePlateNo"       jdbcType="VARCHAR" />
		<result column="DANGEROUS_TYPE_WEEK"    property="dangerousTypeWeek"    jdbcType="DECIMAL" />
		<result column="DANGEROUS_TYPE_MONTH"   property="dangerousTypeMonth"   jdbcType="DECIMAL" />
		<result column="DANGEROUS_TYPE_YEAR"    property="dangerousTypeYear"    jdbcType="DECIMAL" />
		<result column="DANGEROUS_WEIGHT_WEEK"  property="dangerousWeightWeek"  jdbcType="DECIMAL" />
		<result column="DANGEROUS_WEIGHT_MONTH" property="dangerousWeightMonth" jdbcType="DECIMAL" />
		<result column="DANGEROUS_WEIGHT_YEAR"  property="dangerousWeightYear"  jdbcType="DECIMAL" />
		<result column="WAY_BILL_WEEK"          property="wayBillWeek"          jdbcType="DECIMAL" />
		<result column="WAY_BILL_MONTH"         property="wayBillMonth"         jdbcType="DECIMAL" />
		<result column="WAY_BILL_YEAR"          property="wayBillYear"          jdbcType="DECIMAL" />
	</resultMap>


	<!-- 统计物流企业运单数-->
	<select id="countwlEnp" resultType="map">
		SELECT *
		  FROM (SELECT TMP.*, TE.ENTERPRISE_NAME
		          FROM (SELECT T.LOGISTICS_ID, COUNT(T.ID) AS TIMES
		                  FROM T_WAYBILL T
		                 WHERE T.CHECKSTATUS = '111001004'
		                   AND TO_CHAR(T.UPDATE_TIME, 'yyyy') = #{year}
		                   AND T.REMOVE = '0'
		                 GROUP BY T.LOGISTICS_ID) TMP
		          JOIN T_ENTERPRISE TE
		            ON TMP.LOGISTICS_ID = TE.CORPORATE_NO
		           AND TE.REMOVE = '0'
		           AND TE.ENTERPRISE_TYPE = '106001001'
		         ORDER BY TIMES DESC)
		 <!-- WHERE ROWNUM &lt;= 8 -->
	</select>
	
	<!-- 统计化工企业运单数 -->
	<select id="countCar" resultType="map">
		 SELECT *
      FROM (SELECT TMP.*, TE.ENTERPRISE_NAME
              FROM (SELECT T.CHEMICAL_ID, COUNT(T.ID) AS TIMES
                      FROM T_WAYBILL T
                     WHERE T.CHECKSTATUS = '111001004'
                       AND TO_CHAR(T.UPDATE_TIME, 'yyyy') = #{year}
                       AND T.REMOVE = '0'
                     GROUP BY T.CHEMICAL_ID) TMP
              JOIN T_ENTERPRISE TE
                ON TMP.CHEMICAL_ID = TE.CORPORATE_NO
               AND TE.REMOVE = '0'
               AND TE.ENTERPRISE_TYPE = '106001002'
             ORDER BY TIMES DESC)
		<!-- SELECT *
		  FROM (SELECT TMP.*, TE.ENTERPRISE_NAME
		          FROM (SELECT T.LOGISTICS_ID, COUNT(T.ID) AS TIMES
		                  FROM T_WAYBILL T
		                 WHERE T.CHECKSTATUS = '111001004'
		                   AND TO_CHAR(T.UPDATE_TIME, 'yyyy') = #{year}
		                   AND T.REMOVE = '0'
		                 GROUP BY T.LOGISTICS_ID) TMP
		          JOIN T_ENTERPRISE TE
		            ON TMP.LOGISTICS_ID = TE.CORPORATE_NO
		           AND TE.REMOVE = '0'
		           AND TE.ENTERPRISE_TYPE = '106001002'
		         ORDER BY TIMES DESC) -->
	</select>
	
	<!-- 统计各类危险品运单数-->
	<select id="countWaybill" resultType="map">
	    SELECT T.GOODSNAME, COUNT(T.WAYBILL_ID) AS TIMES 
          FROM (SELECT TW.ID FROM T_WAYBILL TW WHERE TW.CHECKSTATUS = '111001004'
          AND TW.REMOVE = '0') TMP
          JOIN T_WAYBILL_GOODS T 
          ON T.WAYBILL_ID = TMP.ID
          WHERE TO_CHAR(T.UPDATE_TIME, 'yyyy') = #{year}
          AND T.REMOVE = '0'                       
        GROUP BY T.GOODSNAME
        ORDER BY TIMES DESC
	</select>
	
	<!-- 统计物流企业运单数-->
	<select id="countwlEnpMon" resultType="map">
		SELECT *
		  FROM (SELECT TMP.*, TE.ENTERPRISE_NAME
		          FROM (SELECT T.LOGISTICS_ID, COUNT(T.ID) AS TIMES
		                  FROM T_WAYBILL T
		                 WHERE T.CHECKSTATUS = '111001004'
		                   AND TO_CHAR(T.UPDATE_TIME, 'yyyy-mm') = #{month}
		                   AND T.REMOVE = '0'
		                 GROUP BY T.LOGISTICS_ID) TMP
		          JOIN T_ENTERPRISE TE
		            ON TMP.LOGISTICS_ID = TE.CORPORATE_NO
		           AND TE.REMOVE = '0'
		           AND TE.ENTERPRISE_TYPE = '106001001'
		         ORDER BY TIMES DESC)
		 <!-- WHERE ROWNUM &lt;= 8 -->
	</select>
	
	<!-- 统计化工企业运单数 -->
	<select id="countCarMon"  resultType="map">
		SELECT *
		  FROM (SELECT TMP.*, TE.ENTERPRISE_NAME
		          FROM (SELECT T.LOGISTICS_ID, COUNT(T.ID) AS TIMES
		                  FROM T_WAYBILL T
		                 WHERE T.CHECKSTATUS = '111001004'
		                   AND TO_CHAR(T.UPDATE_TIME, 'yyyy-mm') = #{month}
		                   AND T.REMOVE = '0'
		                 GROUP BY T.LOGISTICS_ID) TMP
		          JOIN T_ENTERPRISE TE
		            ON TMP.LOGISTICS_ID = TE.CORPORATE_NO
		           AND TE.REMOVE = '0'
		           AND TE.ENTERPRISE_TYPE = '106001002'
		         ORDER BY TIMES DESC)
	</select>
	
	<!-- 统计各类危险品运单数-->
	<select id="countWaybillMon" resultType="map">
	    SELECT T.GOODSNAME, COUNT(T.WAYBILL_ID) AS TIMES 
          FROM (SELECT TW.ID FROM T_WAYBILL TW WHERE TW.CHECKSTATUS = '111001004'
          AND TW.REMOVE = '0') TMP
          JOIN T_WAYBILL_GOODS T 
          ON T.WAYBILL_ID = TMP.ID
          WHERE TO_CHAR(T.UPDATE_TIME, 'yyyy-mm') = #{month}
          AND T.REMOVE = '0'                       
        GROUP BY T.GOODSNAME
        ORDER BY TIMES DESC
	</select>
	
	<!-- 统计物流企业运单数-->
	<select id="countwlEnpWeek" resultType="map">
		SELECT *
		  FROM (SELECT TMP.*, TE.ENTERPRISE_NAME
		          FROM (SELECT T.LOGISTICS_ID, COUNT(T.ID) AS TIMES
		                  FROM T_WAYBILL T
		                 WHERE T.CHECKSTATUS = '111001004'
		                   AND TO_CHAR(T.UPDATE_TIME, 'iw') = #{week}
		                   AND T.REMOVE = '0'
		                 GROUP BY T.LOGISTICS_ID) TMP
		          JOIN T_ENTERPRISE TE
		            ON TMP.LOGISTICS_ID = TE.CORPORATE_NO
		           AND TE.REMOVE = '0'
		           AND TE.ENTERPRISE_TYPE = '106001001'
		         ORDER BY TIMES DESC)
		 <!-- WHERE ROWNUM &lt;= 8 -->
	</select>
	
	<!-- 统计化工企业运单数 -->
	<select id="countCarWeek"  resultType="map">
		SELECT *
		  FROM (SELECT TMP.*, TE.ENTERPRISE_NAME
		          FROM (SELECT T.LOGISTICS_ID, COUNT(T.ID) AS TIMES
		                  FROM T_WAYBILL T
		                 WHERE T.CHECKSTATUS = '111001004'
		                   AND TO_CHAR(T.UPDATE_TIME, 'iw') = #{week}
		                   AND T.REMOVE = '0'
		                 GROUP BY T.LOGISTICS_ID) TMP
		          JOIN T_ENTERPRISE TE
		            ON TMP.LOGISTICS_ID = TE.CORPORATE_NO
		           AND TE.REMOVE = '0'
		           AND TE.ENTERPRISE_TYPE = '106001002'
		         ORDER BY TIMES DESC)
	</select>
	
	<!-- 统计各类危险品运单数-->
	<select id="countWaybillWeek" resultType="map">
	    SELECT T.GOODSNAME, COUNT(T.WAYBILL_ID) AS TIMES 
          FROM (SELECT TW.ID FROM T_WAYBILL TW WHERE TW.CHECKSTATUS = '111001004'
          AND TW.REMOVE = '0') TMP
          JOIN T_WAYBILL_GOODS T 
          ON T.WAYBILL_ID = TMP.ID
          WHERE TO_CHAR(T.UPDATE_TIME, 'iw') = #{week}
          AND T.REMOVE = '0'                       
        GROUP BY T.GOODSNAME
        ORDER BY TIMES DESC
	</select>
	
  <!-- 运单统计（表格） -->
  <select id="countAllByParams" parameterType="map" resultMap="BaseResultMap">
	<!--*********************************运单*******************************--> 
	WITH T_WBI_WEEK AS <!-- 本周运单 -->
	 (SELECT T_WBI.CARNO LICENCE_PLATE_NO, COUNT(T_WBI.ID) WAY_BILL_WEEK
	    FROM T_WAYBILL T_WBI
	   WHERE T_WBI.CHECKSTATUS = '111001004'
	     AND TO_CHAR(T_WBI.UPDATE_TIME, 'iw') IN (#{curWeek})
	     AND T_WBI.REMOVE = '0'
	   GROUP BY T_WBI.LOGISTICS_ID, T_WBI.CARNO),
	   
	T_WBI_MONTH AS <!-- 本月运单 -->
	 (SELECT T_WBI.CARNO LICENCE_PLATE_NO, COUNT(T_WBI.ID) WAY_BILL_MONTH
	    FROM T_WAYBILL T_WBI
	   WHERE T_WBI.CHECKSTATUS = '111001004'
	     AND TO_CHAR(T_WBI.UPDATE_TIME, 'yyyy-mm') IN (#{curMon})
	     AND T_WBI.REMOVE = '0'
	   GROUP BY T_WBI.LOGISTICS_ID, T_WBI.CARNO),
	
	T_WBI_YEAR AS <!-- 本年运单 -->
	 (SELECT T_WBI.CARNO LICENCE_PLATE_NO, COUNT(T_WBI.ID) WAY_BILL_YEAR
	    FROM T_WAYBILL T_WBI
	   WHERE T_WBI.CHECKSTATUS = '111001004'
	     AND TO_CHAR(T_WBI.UPDATE_TIME, 'yyyy') IN (#{curYear})
	     AND T_WBI.REMOVE = '0'
	   GROUP BY T_WBI.LOGISTICS_ID, T_WBI.CARNO),
	   
	T_WBG_WEEK AS <!-- 本周危险品种类 -->
	 (SELECT T_WBG.CARNO, COUNT(T_WBG.A) DANGEROUS_TYPE_WEEK
	    FROM (SELECT DISTINCT(GOODSNAME) AS A, T_WBI.CARNO, WAYBILL_ID, T_WBI.REMOVE, T_WBI.UPDATE_TIME FROM T_WAYBILL_GOODS
	    	LEFT JOIN T_WAYBILL T_WBI
	    	ON T_WAYBILL_GOODS.WAYBILL_ID = T_WBI.ID
	    	WHERE T_WAYBILL_GOODS.REMOVE = '0'
	    	AND   T_WBI.REMOVE = '0'
	    ) T_WBG
	   WHERE TO_CHAR(T_WBG.UPDATE_TIME, 'iw') IN (#{curWeek})
	    <!--  AND T_WBG.REMOVE = '0' -->
	   GROUP BY T_WBG.CARNO),
	   
	T_WBG_MONTH AS <!-- 本月危险品种类 -->
	 (SELECT T_WBG.CARNO, COUNT(T_WBG.A) DANGEROUS_TYPE_MONTH
	    FROM (SELECT DISTINCT(GOODSNAME) AS A, T_WBI.CARNO, WAYBILL_ID, T_WBI.REMOVE, T_WBI.UPDATE_TIME FROM T_WAYBILL_GOODS
	    	LEFT JOIN T_WAYBILL T_WBI
	    	ON T_WAYBILL_GOODS.WAYBILL_ID = T_WBI.ID
	    	WHERE T_WAYBILL_GOODS.REMOVE = '0'
	    	AND   T_WBI.REMOVE = '0'
	    ) T_WBG
	   WHERE TO_CHAR(T_WBG.UPDATE_TIME, 'yyyy-mm') IN (#{curMon})
	    <!--  AND T_WBG.REMOVE = '0' -->
	   GROUP BY T_WBG.CARNO),
	
	T_WBG_YEAR AS <!-- 本年危险品种类 -->
	 (SELECT T_WBG.CARNO, COUNT(T_WBG.A) DANGEROUS_TYPE_YEAR
	    FROM (SELECT DISTINCT(GOODSNAME) AS A, T_WBI.CARNO, WAYBILL_ID, T_WBI.REMOVE, T_WBI.UPDATE_TIME FROM T_WAYBILL_GOODS
	    	LEFT JOIN T_WAYBILL T_WBI
	    	ON T_WAYBILL_GOODS.WAYBILL_ID = T_WBI.ID
	    	WHERE T_WAYBILL_GOODS.REMOVE = '0'
	    	AND   T_WBI.REMOVE = '0'
	    ) T_WBG
	   WHERE TO_CHAR(T_WBG.UPDATE_TIME, 'yyyy') IN (#{curYear})
	    <!--  AND T_WBG.REMOVE = '0' -->
	   GROUP BY T_WBG.CARNO),
	   
	T_WBGD_WEEK AS <!-- 本周危险品重量 -->
	 (SELECT T_WBI.CARNO, SUM(T_WBGD.WEIGHT) DANGEROUS_WEIGHT_WEEK
	    FROM T_WAYBILL_GOODS T_WBGD
	    	LEFT JOIN T_WAYBILL T_WBI
	    	ON T_WBGD.WAYBILL_ID = T_WBI.ID
	   WHERE TO_CHAR(T_WBGD.UPDATE_TIME, 'iw') IN (#{curWeek})
	   	 AND T_WBI.REMOVE  = '0'
	     AND T_WBGD.REMOVE = '0'
	   GROUP BY T_WBI.CARNO),
	   
	T_WBGD_MONTH AS <!-- 本月危险品重量-->
	 (SELECT T_WBI.CARNO, SUM(T_WBGD.WEIGHT) DANGEROUS_WEIGHT_MONTH
	    FROM T_WAYBILL_GOODS T_WBGD
	    	LEFT JOIN T_WAYBILL T_WBI
	    	ON T_WBGD.WAYBILL_ID = T_WBI.ID
	   WHERE TO_CHAR(T_WBGD.UPDATE_TIME, 'yyyy-mm') IN (#{curMon})
	     AND T_WBI.REMOVE  = '0'
	     AND T_WBGD.REMOVE = '0'
	   GROUP BY T_WBI.CARNO),
	
	T_WBGD_YEAR AS <!-- 本年危险品重量-->
	 (SELECT T_WBI.CARNO, SUM(T_WBGD.WEIGHT) DANGEROUS_WEIGHT_YEAR
	    FROM T_WAYBILL_GOODS T_WBGD
	    	LEFT JOIN T_WAYBILL T_WBI
	    	ON T_WBGD.WAYBILL_ID = T_WBI.ID
	   WHERE TO_CHAR(T_WBGD.UPDATE_TIME, 'yyyy') IN (#{curYear})
	   	 AND T_WBI.REMOVE  = '0'
	     AND T_WBGD.REMOVE = '0'
	   GROUP BY T_WBI.CARNO)
	
	<!--*********************************总查询*******************************--> 
	SELECT DISTINCT(T.CARNO) LICENCE_PLATE_NO,
		  <!-- T.ID,运单号要删除，否则还是会返回重复的车牌号 -->
	      <!--  T.CARNO LICENCE_PLATE_NO, 车牌号要DISTINCT过滤掉重复的，而且只能排在SELECT后面的第一列-->
	       NVL(T_WBI_WEEK.WAY_BILL_WEEK,    0) WAY_BILL_WEEK,
	       NVL(T_WBI_MONTH.WAY_BILL_MONTH,   0) WAY_BILL_MONTH,
	       NVL(T_WBI_YEAR.WAY_BILL_YEAR,    0) WAY_BILL_YEAR,
	       NVL(T_WBG_WEEK.DANGEROUS_TYPE_WEEK,     0) DANGEROUS_TYPE_WEEK,
	       NVL(T_WBG_MONTH.DANGEROUS_TYPE_MONTH,    0) DANGEROUS_TYPE_MONTH,
	       NVL(T_WBG_YEAR.DANGEROUS_TYPE_YEAR,     0) DANGEROUS_TYPE_YEAR,
	       NVL(T_WBGD_WEEK.DANGEROUS_WEIGHT_WEEK,    0) DANGEROUS_WEIGHT_WEEK,
	       NVL(T_WBGD_MONTH.DANGEROUS_WEIGHT_MONTH,   0) DANGEROUS_WEIGHT_MONTH,
	       NVL(T_WBGD_YEAR.DANGEROUS_WEIGHT_YEAR,    0) DANGEROUS_WEIGHT_YEAR
	  FROM T_WAYBILL T
	    LEFT JOIN T_WBI_WEEK ON T.CARNO =  T_WBI_WEEK.LICENCE_PLATE_NO
	    LEFT JOIN T_WBI_MONTH ON T.CARNO = T_WBI_MONTH.LICENCE_PLATE_NO
	    LEFT JOIN T_WBI_YEAR ON T.CARNO =  T_WBI_YEAR.LICENCE_PLATE_NO
	    LEFT JOIN T_WBG_WEEK ON T.CARNO = T_WBG_WEEK.CARNO
	    LEFT JOIN T_WBG_MONTH ON T.CARNO = T_WBG_MONTH.CARNO
	    LEFT JOIN T_WBG_YEAR ON T.CARNO = T_WBG_YEAR.CARNO
	    LEFT JOIN T_WBGD_WEEK ON T.CARNO = T_WBGD_WEEK.CARNO
	    LEFT JOIN T_WBGD_MONTH ON T.CARNO = T_WBGD_MONTH.CARNO
	    LEFT JOIN T_WBGD_YEAR ON T.CARNO = T_WBGD_YEAR.CARNO
	 WHERE T.REMOVE = '0' AND T.CHECKSTATUS = '111001004'
<!--      ORDER BY ONS, CUR_YEAR_WAYBILL DESC -->
  </select>

</mapper>