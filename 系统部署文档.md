#### 依赖外部项目服务

```
前端
ASOCO 危废监管平台 (http://192.168.108.141:8080/asoco-dangerchemical-waste-web)(未知)
危废一张图服务 (未部署)
企业视频播放服务 (未部署)
后端 
ASOCO 危废监管平台 (http://192.168.1.222:8080/asoco-dangerchemical-waste-server)(已部署)
源码地址：http://36.22.178.70:10080/asoco/asoco-dangerchemical-waste-server
```

#### 关闭防火墙和SELinux

```
# 防火墙
systemctl stop firewalld
systemctl disable firewalld
# SELinux
setenforce 0
vi /etc/sysconfig/selinux # 设置开机读取配置：SELINUX=permissive
```

#### 配置EPEL源以及安装相关组件

```
yum install -y epel-release
yum install -y git nginx chrony
```

#### 系统时间同步

```
systemctl start chronyd
systemctl enable chronyd
# 设置时区
timedatectl set-timezone 'Asia/Shanghai'
```

#### 安装Docker、Docker Compose，设置开机启动

```
# 下载docker
wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-18.03.1.ce-1.el7.centos.x86_64.rpm
# 安装
yum localinstall -y docker-ce-18.03.1.ce-1.el7.centos.x86_64.rpm
# 下载Docker Compose
curl -L https://github.com/docker/compose/releases/download/1.22.0/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
# 修改可执行权限
chmod +x /usr/local/bin/docker-compose
```

#### Node.js，pm2，yarn

```
# 下载
wget https://nodejs.org/dist/v8.11.4/node-v8.11.4-linux-x64.tar.xz -P ~/Downloads;
# 解压
tar -xJf ~/Downloads/node-v8.11.4-linux-x64.tar.xz -C /opt;
# 设置环境变量
echo 'PATH=$PATH:/opt/node-v8.11.4-linux-x64/bin' >> /etc/profile;

# 安装其他的node程序
npm i -g pm2 yarn
```

#### 安装Mysql5.7 

```
version: '3'

services:

  mysql:

    image: mysql:5.7

    container_name: mysql5.7

    restart: on-failure

    ports:

    - '3306:3306'

    environment:

    # 这里自定义一个密码

    - MYSQL_ROOT_PASSWORD=password

    volumes:

    - data:/var/lib/mysql

    # 开启二进制日志

    command: [

      "--log-bin=mysql-bin",

      "--server-id=1"

    ]

volumes:

  data:
```

#### Java JDK 1.8

```
# 下载JDK8
wget --no-check-certificate --no-cookies --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u181-b13/96a7b8442fe848ef90c96a2fad6ed6d1/jdk-8u181-linux-x64.rpm
# 安装
yum localinstall jdk-8u181-linux-x64.rpm
```

#### 安装redis

```
version: '3'

services:

  redis:

    image: redis:4

    container_name: redis4

    ports:

    - '6379:6379'

    volumes:

    - data:/data

volumes:

  data:
```

#### Nginx

```
# 启动，开机启动
systemctl start nginx
systemctl enable nginx
```

#### 拉取代码

```
mkdir -p ~/src
cd ~/src
git clone http://36.22.178.70:10080/asoco/asoco-dangerchemical-waste-server.git  # 后端
git clone http://36.22.178.70:10080/asoco/asoco-dangerchemical-waste-web.git  # 前端
```

#### 发布前端(未修改)

```
修改 /src/config/index.js 中videoUrl属性

    videoUrl: {
        dev: 'http://192.168.1.10:6713',
        //pro: 'http://192.168.1.10:6713', // 测试环境地址
        pro: 'http://172.31.254.11:6713', // 生产环境地址
      }
cd ~/src/asoco-dangerchemical-waste-web
yarn
npm run build
```

#### 导入数据库ssh

```
新建数据用户：root，密码：whpzy.123
新建数据库192.168.1.222
导入wfjg.sql
```

#### 发布后端(生产环境)

```
cd ~/src/asoco-dangerchemical-waste-server
sh deploy # 如有必要，编辑pm2.config.js覆盖内部配置
```

#### 发布后端(测试环境)

```
ssh root@192.168.1.222
输入密码：whpzy.123
cd ~/src/asoco-dangerchemical-waste-server
pm2 list：查看所有进程
pm2 stop 进程id：停止当前进程
git pull：拉取代码
./mvnw clean package -Dmaven.test.skip=true
pm2 restart 进程id
pm2.config.js # 如有必要，编辑pm2.config.js覆盖内部配置
```

#### 配置Nginx以及域名

    server {
            listen       9000;
            server_name  localhost;
        #charset koi8-r;
    
        #access_log  logs/host.access.log  main;
    
        location / {
            add_header Cache-Control no-store;
            add_header Pragma no-cache;
            #root   dist目录;
            root   /root/src/asoco-dangerchemical-waste-web/dist;
            index  index.html;
    
            if (!-e $request_filename) {
               rewrite ^/(.*) /index.html last;
               break;
            }
        }
    
        location /api {
            proxy_set_header   X-Real-IP            $remote_addr;
            proxy_set_header   Host                 $http_host;
            proxy_set_header   X-Forwarded-Proto    $scheme;
            proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
            #封闭园区后台服务地址
            proxy_pass         http://localhost:9001/api/;
        }
        location /amap {
                     proxy_set_header   X-Real-IP            $remote_addr;
                     proxy_set_header   Host                 $http_host;
                     proxy_set_header   X-Forwarded-Proto    $scheme;
                     proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
                     proxy_pass         http://192.168.10.184:8000/amap/;
        }
         location /app {
                     proxy_set_header   X-Real-IP            $remote_addr;
                     proxy_set_header   Host                 $http_host;
                     proxy_set_header   X-Forwarded-Proto    $scheme;
                     proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
                     proxy_pass         https://encp.iasoco.com/app-api-server/api/;
         }
           }

